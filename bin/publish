#!/bin/bash

sector=user
recurse_opt=""
things=()

while [[ $# > 0 ]]
do
    key="$1"
    case $key in
	-sector)
	    sector="$2"
	    shift
	    ;;
	-recurse)
	    recurse_opt=-recurse
	    ;;
	*)
	    things+=("$key")
	    ;;
    esac
    shift
done

# echo "publish: Sector: $sector"
# echo "publish: Upload options: $recurse_opt"
# echo "publish: Publishing ${things[@]}..."

ccouch3 id "${things[@]}"
#ccouch3 store-stream "${things[@]}"

set -x
exec ccouch3 upload \
     $recurse_opt \
     -http-server:piccouch piccouch.appspot.com \
     -command-server:zappie1 ssh tog@zappie1.nuke24.net "ccouch3 cmd-server -sector '$sector'" ';' \
     -command-server:fs.marvin ssh tog@fs.marvin.nuke24.net "ccouch3 cmd-server -sector '$sector'" ';' \
     "${things[@]}"
